name: Build Cosmopolitan FFmpeg (Experimental)

on:
  workflow_dispatch:
    inputs:
      cosmocc_version:
        description: 'Cosmopolitan toolchain version'
        required: true
        default: '3.3.10'
        type: string
      ffmpeg_version:
        description: 'FFmpeg git tag (e.g., n7.1, n8.0)'
        required: true
        default: 'n7.1'
        type: string
      minimal_build:
        description: 'Minimal build (fewer codecs for better compatibility)'
        required: false
        type: boolean
        default: true

env:
  COSMOCC_DIR: cosmocc/bin

jobs:
  build-cosmopolitan:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            yasm \
            nasm \
            git \
            wget \
            unzip

      - name: Download Cosmopolitan toolchain
        run: |
          COSMO_VERSION="${{ inputs.cosmocc_version }}"
          echo "Downloading cosmocc version ${COSMO_VERSION}..."

          wget -q "https://github.com/jart/cosmopolitan/releases/download/${COSMO_VERSION}/cosmocc-${COSMO_VERSION}.zip"
          mkdir -p cosmocc
          unzip -q "cosmocc-${COSMO_VERSION}.zip" -d cosmocc

          # Verify tools exist and show their locations
          echo "=== All Cosmopolitan tools ==="
          ls -la cosmocc/bin/ | head -50

          # Create symlinks for tools that FFmpeg expects
          cd cosmocc/bin
          if [ ! -f cosmoranlib ] && [ -f x86_64-unknown-cosmo-ranlib ]; then
            ln -sf x86_64-unknown-cosmo-ranlib cosmoranlib
          fi
          if [ ! -f cosmoranlib ]; then
            # If no ranlib exists, create a script that uses ar -s
            echo '#!/bin/sh' > cosmoranlib
            echo 'exec "$(dirname "$0")/cosmoar" -s "$@"' >> cosmoranlib
            chmod +x cosmoranlib
          fi
          cd ../..

          # Add to PATH for all subsequent steps
          echo "${{ github.workspace }}/cosmocc/bin" >> $GITHUB_PATH

      - name: Register APE loader
        run: |
          # Register the APE (Actually Portable Executable) loader
          if [ -f cosmocc/bin/ape-x86_64.elf ]; then
            sudo sh -c "echo ':APE:M::MZqFpD::/usr/bin/ape-x86_64.elf:' > /proc/sys/fs/binfmt_misc/register" || true
            sudo cp cosmocc/bin/ape-x86_64.elf /usr/bin/ || true
          fi

      - name: Clone FFmpeg
        run: |
          git clone --depth 1 --branch ${{ inputs.ffmpeg_version }} https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      - name: Configure FFmpeg for Cosmopolitan
        run: |
          cd ffmpeg-src

          # Use absolute paths for Cosmopolitan tools
          COSMO_BIN="${{ github.workspace }}/cosmocc/bin"
          export CC="${COSMO_BIN}/cosmocc"
          export CXX="${COSMO_BIN}/cosmoc++"
          export AR="${COSMO_BIN}/cosmoar"
          export RANLIB="${COSMO_BIN}/cosmoranlib"
          export NM="${COSMO_BIN}/x86_64-unknown-cosmo-nm"
          export STRIP="${COSMO_BIN}/x86_64-unknown-cosmo-strip"

          # Verify tools exist
          echo "CC=${CC}"
          ls -la "${CC}" || echo "Warning: CC not found"
          ls -la "${AR}" || echo "Warning: AR not found"
          ls -la "${RANLIB}" || echo "Warning: RANLIB not found"

          if [ "${{ inputs.minimal_build }}" = "true" ]; then
            # Minimal build - disable problematic features for Cosmopolitan
            ./configure \
              --cc="${CC}" \
              --cxx="${CXX}" \
              --ar="${AR}" \
              --ranlib="${RANLIB}" \
              --enable-cross-compile \
              --target-os=linux \
              --arch=x86_64 \
              --enable-static \
              --disable-shared \
              --disable-doc \
              --disable-ffplay \
              --disable-network \
              --disable-autodetect \
              --disable-debug \
              --disable-asm \
              --disable-x86asm \
              --disable-inline-asm \
              --disable-pthreads \
              --disable-w32threads \
              --disable-os2threads \
              --enable-protocol=file \
              --enable-protocol=pipe \
              --disable-devices \
              --disable-filters \
              --enable-filter=aresample \
              --enable-filter=scale \
              --enable-filter=format \
              --enable-filter=null \
              --enable-filter=anull \
              --extra-cflags="-Os -fno-pie -static -D_GNU_SOURCE" \
              --extra-ldflags="-static -fno-pie"
          else
            # Full build - may have compatibility issues
            ./configure \
              --cc="${CC}" \
              --cxx="${CXX}" \
              --ar="${AR}" \
              --ranlib="${RANLIB}" \
              --enable-cross-compile \
              --target-os=linux \
              --arch=x86_64 \
              --enable-gpl \
              --enable-static \
              --disable-shared \
              --disable-doc \
              --disable-ffplay \
              --disable-debug \
              --disable-asm \
              --disable-x86asm \
              --disable-inline-asm \
              --disable-pthreads \
              --disable-w32threads \
              --disable-os2threads \
              --extra-cflags="-Os -fno-pie -static -D_GNU_SOURCE" \
              --extra-ldflags="-static -fno-pie"
          fi

          # Patch config.h to disable sysctl (Cosmopolitan doesn't have sys/sysctl.h)
          echo "Patching config.h to disable HAVE_SYSCTL..."
          sed -i 's/#define HAVE_SYSCTL 1/#define HAVE_SYSCTL 0/' config.h
          grep HAVE_SYSCTL config.h || echo "HAVE_SYSCTL not found in config.h"

      - name: Build FFmpeg
        run: |
          cd ffmpeg-src

          # Use absolute paths for Cosmopolitan tools during build
          COSMO_BIN="${{ github.workspace }}/cosmocc/bin"
          export PATH="${COSMO_BIN}:$PATH"
          export CC="${COSMO_BIN}/cosmocc"
          export CXX="${COSMO_BIN}/cosmoc++"
          export AR="${COSMO_BIN}/cosmoar"
          export RANLIB="${COSMO_BIN}/cosmoranlib"

          # Build with parallel jobs, show last 200 lines on failure
          make -j$(nproc) 2>&1 || { echo "=== Build failed, retrying with single job ==="; make -j1 V=1 2>&1 | tail -200; exit 1; }

      - name: Package as APE binaries
        run: |
          mkdir -p output/cosmopolitan

          # Rename to .com extension for Actually Portable Executables
          if [ -f ffmpeg-src/ffmpeg ]; then
            cp ffmpeg-src/ffmpeg output/cosmopolitan/ffmpeg.com
            echo "Created ffmpeg.com"
          else
            echo "Warning: ffmpeg binary not found"
          fi

          if [ -f ffmpeg-src/ffprobe ]; then
            cp ffmpeg-src/ffprobe output/cosmopolitan/ffprobe.com
            echo "Created ffprobe.com"
          else
            echo "Warning: ffprobe binary not found"
          fi

          chmod +x output/cosmopolitan/*.com 2>/dev/null || true

          # Show binary info
          echo "=== Binary info ==="
          file output/cosmopolitan/*.com 2>/dev/null || echo "No binaries to inspect"
          ls -la output/cosmopolitan/

          # Test execution if possible
          if [ -f output/cosmopolitan/ffmpeg.com ]; then
            ./output/cosmopolitan/ffmpeg.com -version || echo "Binary created but test execution failed (expected in some CI environments)"
          fi

          # Create ZIP
          cd output
          zip -r cosmopolitan.zip cosmopolitan/
          mv cosmopolitan.zip ../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-cosmopolitan-${{ inputs.ffmpeg_version }}
          path: cosmopolitan.zip
          retention-days: 90
          if-no-files-found: warn

      - name: Build notes
        run: |
          echo "=== Cosmopolitan FFmpeg Build Notes ==="
          echo ""
          echo "The .com files are Actually Portable Executables that can run on:"
          echo "  - Linux (x86_64, aarch64)"
          echo "  - macOS (x86_64, aarch64)"
          echo "  - Windows (x86_64)"
          echo "  - FreeBSD, NetBSD, OpenBSD"
          echo ""
          echo "To run on Windows, you may need to rename .com to .exe"
          echo "On first run, the APE loader may need to extract native code"
          echo ""
          if [ "${{ inputs.minimal_build }}" = "true" ]; then
            echo "This is a MINIMAL build with limited codec support"
            echo "Only file/pipe protocols and basic filters are enabled"
          else
            echo "This is a FULL build with most codecs enabled"
            echo "Some features may not work on all platforms"
          fi
